<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Access Nature - Trail Tracker</title>
  <meta name="description" content="GPS trail tracking with accessibility documentation. Map outdoor routes and create comprehensive accessibility guides.">
  
  <!-- Leaflet Map Library -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  
  <!-- Your Firebase Setup - Must be loaded as module -->
  <script type="module" src="./firebase-setup.js"></script>
  
  <!-- Enhanced UI Styles - Self-contained -->
  <style>
    /* CSS Reset and Base Styles */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }

    /* Skip link for accessibility */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 6px;
      background: #000;
      color: #fff;
      padding: 8px 16px;
      text-decoration: none;
      z-index: 10000;
      border-radius: 4px;
      font-weight: 500;
      transition: top 0.3s ease;
    }

    .skip-link:focus {
      top: 6px;
      outline: 3px solid #FFD700;
    }

    /* Main container */
    .enhanced-container {
      position: relative;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }

    /* Full-screen map */
    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    /* Status header - top banner */
    .enhanced-status-header {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(12px);
      padding: 8px 24px;
      border-radius: 25px;
      z-index: 2000;
      display: flex;
      gap: 24px;
      align-items: center;
      box-shadow: 0 4px 25px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      min-width: 280px;
    }

    .status-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.85rem;
      flex: 1;
      min-width: 60px;
    }

    .status-value {
      font-size: 1.1rem;
      font-weight: bold;
      color: #4CAF50;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      line-height: 1;
    }

    .status-label {
      font-size: 0.7rem;
      color: #ccc;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-top: 2px;
      line-height: 1;
    }

    /* Compass section */
    .enhanced-compass-section {
      position: fixed;
      top: 75px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .enhanced-compass-container {
      position: relative;
      width: 60px;
      height: 60px;
      background: rgba(0, 0, 0, 0.85);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(12px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    .enhanced-compass-needle {
      position: absolute;
      width: 3px;
      height: 40px;
      transform-origin: 50% 50%;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .enhanced-compass-needle::before {
      content: '';
      position: absolute;
      top: -8px;
      left: -6px;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 20px solid #ff4444;
    }

    .enhanced-compass-needle::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: -4px;
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 16px solid #ffffff;
    }

    .enhanced-compass-reading {
      background: rgba(0, 0, 0, 0.8);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
      color: #fff;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      min-width: 60px;
      text-align: center;
    }

    /* Map rotation control */
    .enhanced-rotation-control {
      position: fixed;
      top: 15px;
      right: 15px;
      width: 50px;
      height: 50px;
      background: rgba(0, 0, 0, 0.85);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(12px);
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    .enhanced-rotation-control:hover {
      background: rgba(76, 175, 80, 0.85);
      border-color: rgba(76, 175, 80, 0.6);
      transform: scale(1.1);
    }

    .enhanced-rotation-control.active {
      background: rgba(76, 175, 80, 0.9);
      border-color: #4CAF50;
    }

    /* Main tracking controls */
    .enhanced-tracking-controls {
      position: fixed;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      z-index: 2000;
      align-items: center;
    }

    .enhanced-control-btn {
      width: 60px;
      height: 60px;
      border: none;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(12px);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }

    .enhanced-accessibility-btn {
      background: rgba(33, 150, 243, 0.9);
      color: white;
    }

    .enhanced-accessibility-btn:hover, .enhanced-accessibility-btn:focus {
      background: rgba(33, 150, 243, 1);
      transform: scale(1.1);
      box-shadow: 0 8px 30px rgba(33, 150, 243, 0.4);
    }

    .enhanced-play-btn {
      background: rgba(76, 175, 80, 0.9);
      color: white;
      width: 80px;
      height: 80px;
      font-size: 2rem;
    }

    .enhanced-play-btn:hover, .enhanced-play-btn:focus {
      background: rgba(76, 175, 80, 1);
      transform: scale(1.1);
      box-shadow: 0 8px 30px rgba(76, 175, 80, 0.4);
    }

    .enhanced-play-btn.tracking {
      background: rgba(255, 152, 0, 0.9);
    }

    .enhanced-play-btn.tracking:hover {
      background: rgba(255, 152, 0, 1);
      box-shadow: 0 8px 30px rgba(255, 152, 0, 0.4);
    }

    .enhanced-play-btn.paused {
      background: rgba(33, 150, 243, 0.9);
    }

    .enhanced-play-btn.paused:hover {
      background: rgba(33, 150, 243, 1);
      box-shadow: 0 8px 30px rgba(33, 150, 243, 0.4);
    }

    .enhanced-save-btn {
      background: rgba(96, 125, 139, 0.6);
      color: #ccc;
    }

    .enhanced-save-btn.ready {
      background: rgba(244, 67, 54, 0.9);
      color: white;
    }

    .enhanced-save-btn.ready:hover, .enhanced-save-btn.ready:focus {
      background: rgba(244, 67, 54, 1);
      transform: scale(1.1);
      box-shadow: 0 8px 30px rgba(244, 67, 54, 0.4);
    }

    /* Bottom menu */
    .enhanced-bottom-menu {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(12px);
      padding: 12px 20px;
      border-radius: 25px;
      display: flex;
      gap: 30px;
      z-index: 2000;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .enhanced-menu-btn {
      background: none;
      border: none;
      color: #fff;
      padding: 8px;
      cursor: pointer;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: all 0.3s ease;
      min-width: 50px;
    }

    .enhanced-menu-btn:hover, .enhanced-menu-btn:focus {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

    .enhanced-menu-icon {
      font-size: 1.2rem;
      line-height: 1;
    }

    .enhanced-menu-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
      line-height: 1;
    }

    .enhanced-home-btn {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Accessibility Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      backdrop-filter: blur(8px);
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      color: #333;
    }

    .modal-header {
      background: #2196F3;
      color: white;
      padding: 20px;
      position: relative;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
    }

    .modal-close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s ease;
    }

    .modal-close-btn:hover, .modal-close-btn:focus {
      background: rgba(255, 255, 255, 0.3);
    }

    .modal-body {
      padding: 0;
      max-height: calc(90vh - 140px);
      overflow-y: auto;
    }

    .accessibility-form {
      padding: 30px;
    }

    .accessibility-form fieldset {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 25px;
      background: #fafafa;
    }

    .accessibility-form legend {
      font-weight: 600;
      color: #2196F3;
      padding: 0 10px;
      font-size: 1.1rem;
    }

    .accessibility-form .form-group {
      margin-bottom: 20px;
    }

    .accessibility-form label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }

    .accessibility-form input,
    .accessibility-form select,
    .accessibility-form textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .accessibility-form input:focus,
    .accessibility-form select:focus,
    .accessibility-form textarea:focus {
      outline: none;
      border-color: #2196F3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }

    .accessibility-form textarea {
      resize: vertical;
      min-height: 100px;
    }

    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .radio-item {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background-color 0.3s ease;
    }

    .radio-item:hover {
      background: rgba(33, 150, 243, 0.05);
    }

    .radio-item input {
      width: auto;
      margin: 0;
    }

    .form-actions {
      background: #f5f5f5;
      padding: 20px 30px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 15px;
      justify-content: flex-end;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 100px;
    }

    .btn-primary {
      background: #2196F3;
      color: white;
    }

    .btn-primary:hover, .btn-primary:focus {
      background: #1976D2;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }

    .btn-secondary {
      background: #757575;
      color: white;
    }

    .btn-secondary:hover, .btn-secondary:focus {
      background: #616161;
    }

    /* Tooltips */
    .enhanced-control-btn, .enhanced-menu-btn, .enhanced-rotation-control {
      position: relative;
    }

    .enhanced-control-btn::after, .enhanced-menu-btn::after, .enhanced-rotation-control::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1000;
      margin-bottom: 8px;
    }

    .enhanced-control-btn:hover::after, .enhanced-menu-btn:hover::after, .enhanced-rotation-control:hover::after,
    .enhanced-control-btn:focus::after, .enhanced-menu-btn:focus::after, .enhanced-rotation-control:focus::after {
      opacity: 1;
    }

    .enhanced-menu-btn::after {
      bottom: auto;
      top: 100%;
      margin-bottom: 0;
      margin-top: 8px;
    }

    /* Error and success messages */
    .error-message, .success-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 500;
      z-index: 10000;
      max-width: 90%;
      text-align: center;
      animation: slideInDown 0.3s ease-out;
    }

    .error-message {
      background: rgba(239, 68, 68, 0.95);
      color: white;
      border: 1px solid #dc2626;
    }

    .success-message {
      background: rgba(34, 197, 94, 0.95);
      color: white;
      border: 1px solid #16a34a;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* Mobile optimizations */
    @media (max-width: 480px) {
      .enhanced-status-header {
        min-width: 250px;
        gap: 15px;
        padding: 6px 16px;
      }

      .status-item {
        min-width: 50px;
      }

      .status-value {
        font-size: 1rem;
      }

      .status-label {
        font-size: 0.65rem;
      }

      .enhanced-tracking-controls {
        gap: 15px;
        bottom: 110px;
      }

      .enhanced-control-btn {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
      }

      .enhanced-play-btn {
        width: 65px;
        height: 65px;
        font-size: 1.5rem;
      }

      .enhanced-bottom-menu {
        gap: 20px;
        padding: 10px 16px;
      }

      .enhanced-menu-btn {
        min-width: 45px;
      }

      .enhanced-menu-icon {
        font-size: 1.1rem;
      }

      .enhanced-menu-label {
        font-size: 0.65rem;
      }
    }
  </style>
</head>
<body>
  <!-- Skip link for accessibility -->
  <a href="#map" class="skip-link">Skip to map</a>

  <div class="enhanced-container">
    <!-- Your existing map container -->
    <div id="map" role="application" aria-label="Interactive trail map"></div>

    <!-- Enhanced Status Header -->
    <div class="enhanced-status-header" role="status" aria-live="polite">
      <div class="status-item">
        <div class="status-value" id="timerDisplay" aria-label="elapsed time">00:00:00</div>
        <div class="status-label">Time</div>
      </div>
      <div class="status-item">
        <div class="status-value" id="distanceDisplay" aria-label="distance traveled">0.0 km</div>
        <div class="status-label">Distance</div>
      </div>
      <div class="status-item">
        <div class="status-value" id="pointsDisplay" aria-label="GPS points recorded">0</div>
        <div class="status-label">Points</div>
      </div>
    </div>

    <!-- Enhanced Compass Section -->
    <div class="enhanced-compass-section">
      <div class="enhanced-compass-container" title="Current compass heading and direction">
        <div id="compassNeedle" class="enhanced-compass-needle"></div>
      </div>
      <div id="compassReading" class="enhanced-compass-reading">0¬∞ N</div>
    </div>

    <!-- Enhanced Map Rotation Control -->
    <button id="rotationToggle" class="enhanced-rotation-control" 
            onclick="toggleMapRotation()"
            aria-label="Toggle map rotation with compass"
            title="Enable/disable map rotation to match your heading">
      <span>üß≠</span>
    </button>

    <!-- Enhanced Main Tracking Controls -->
    <div class="enhanced-tracking-controls">
      <button id="accessibilityBtn" class="enhanced-control-btn enhanced-accessibility-btn" 
              onclick="openAccessibilityForm()"
              aria-label="Open accessibility survey"
              title="Document trail accessibility features and barriers">
        <span>‚ôø</span>
      </button>
      
      <button id="playPauseBtn" class="enhanced-control-btn enhanced-play-btn" 
              onclick="toggleTracking()"
              aria-label="Start tracking"
              title="Start GPS tracking of your route">
        <span>‚ñ∂</span>
      </button>
      
      <button id="saveBtn" class="enhanced-control-btn enhanced-save-btn" 
              onclick="saveRoute()"
              aria-label="Save route"
              title="Save your tracked route and accessibility data">
        <span>üíæ</span>
      </button>
    </div>

    <!-- Enhanced Bottom Menu -->
    <nav class="enhanced-bottom-menu" role="navigation" aria-label="Main actions">
      <button class="enhanced-menu-btn" onclick="addNote()" 
              aria-label="Add note to current location"
              title="Add a note about trail conditions or accessibility features">
        <span class="enhanced-menu-icon">üìù</span>
        <span class="enhanced-menu-label">Note</span>
      </button>
      
      <button class="enhanced-menu-btn" onclick="capturePhoto()" 
              aria-label="Take photo at current location"
              title="Capture photo documentation of trail features">
        <span class="enhanced-menu-icon">üì∑</span>
        <span class="enhanced-menu-label">Photo</span>
      </button>
      
      <button class="enhanced-menu-btn enhanced-home-btn" onclick="goHome()" 
              aria-label="Return to home page"
              title="Return to Access Nature home page">
        <span class="enhanced-menu-icon">üè†</span>
        <span class="enhanced-menu-label">Home</span>
      </button>
      
      <button class="enhanced-menu-btn" onclick="openMainMenu()" 
              aria-label="Open main menu"
              title="Access export options, settings, and more features">
        <span class="enhanced-menu-icon">‚ò∞</span>
        <span class="enhanced-menu-label">Menu</span>
      </button>
    </nav>
  </div>

  <!-- Accessibility Survey Modal -->
  <div id="accessibilityModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="accessibilityModalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="accessibilityModalTitle">Trail Accessibility Survey</h2>
        <button class="modal-close-btn" onclick="closeAccessibilityForm()" 
                aria-label="Close accessibility survey"
                title="Close survey and return to map">
          √ó
        </button>
      </div>
      
      <div class="modal-body">
        <form id="accessibilityForm" class="accessibility-form">
          <!-- Trail Information -->
          <fieldset>
            <legend>Trail Information</legend>
            
            <div class="form-group">
              <label for="trailName">Trail Name</label>
              <input type="text" id="trailName" name="trailName" placeholder="Enter trail name">
            </div>
            
            <div class="form-group">
              <label for="trailType">Trail Type</label>
              <select id="trailType" name="trailType">
                <option value="">Select trail type</option>
                <option value="hiking">Hiking Trail</option>
                <option value="walking">Walking Path</option>
                <option value="nature">Nature Trail</option>
                <option value="boardwalk">Boardwalk</option>
                <option value="paved">Paved Path</option>
                <option value="other">Other</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="difficulty">Overall Difficulty</label>
              <div class="radio-group">
                <div class="radio-item">
                  <input type="radio" id="easy" name="difficulty" value="easy">
                  <label for="easy">Easy - Suitable for all abilities</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="moderate" name="difficulty" value="moderate">
                  <label for="moderate">Moderate - Some challenges</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="difficult" name="difficulty" value="difficult">
                  <label for="difficult">Difficult - Significant barriers</label>
                </div>
              </div>
            </div>
          </fieldset>

          <!-- Wheelchair Accessibility -->
          <fieldset>
            <legend>Wheelchair Accessibility</legend>
            
            <div class="form-group">
              <label for="wheelchairAccessible">Wheelchair Accessible?</label>
              <div class="radio-group">
                <div class="radio-item">
                  <input type="radio" id="wheelchairYes" name="wheelchairAccessible" value="yes">
                  <label for="wheelchairYes">Fully Accessible</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="wheelchairPartial" name="wheelchairAccessible" value="partial">
                  <label for="wheelchairPartial">Partially Accessible</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="wheelchairNo" name="wheelchairAccessible" value="no">
                  <label for="wheelchairNo">Not Accessible</label>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label for="pathWidth">Path Width (minimum in cm)</label>
              <input type="number" id="pathWidth" name="pathWidth" min="0" step="10" placeholder="e.g., 120">
            </div>
            
            <div class="form-group">
              <label for="maxGrade">Maximum Grade/Slope (%)</label>
              <input type="number" id="maxGrade" name="maxGrade" min="0" max="100" step="1" placeholder="e.g., 8">
            </div>
          </fieldset>

          <!-- Surface Conditions -->
          <fieldset>
            <legend>Surface Conditions</legend>
            
            <div class="form-group">
              <label for="surfaceType">Primary Surface Type</label>
              <select id="surfaceType" name="surfaceType">
                <option value="">Select surface type</option>
                <option value="paved">Paved/Concrete</option>
                <option value="asphalt">Asphalt</option>
                <option value="compacted">Compacted Gravel</option>
                <option value="loose_gravel">Loose Gravel</option>
                <option value="dirt">Dirt/Earth</option>
                <option value="sand">Sand</option>
                <option value="grass">Grass</option>
                <option value="boardwalk">Boardwalk/Wood</option>
                <option value="rock">Rock/Stone</option>
                <option value="mixed">Mixed Surfaces</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="surfaceCondition">Surface Condition</label>
              <div class="radio-group">
                <div class="radio-item">
                  <input type="radio" id="surfaceExcellent" name="surfaceCondition" value="excellent">
                  <label for="surfaceExcellent">Excellent - Smooth, even surface</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="surfaceGood" name="surfaceCondition" value="good">
                  <label for="surfaceGood">Good - Minor irregularities</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="surfaceFair" name="surfaceCondition" value="fair">
                  <label for="surfaceFair">Fair - Some obstacles/uneven areas</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="surfacePoor" name="surfaceCondition" value="poor">
                  <label for="surfacePoor">Poor - Many obstacles/very uneven</label>
                </div>
              </div>
            </div>
          </fieldset>

          <!-- Additional Notes -->
          <fieldset>
            <legend>Additional Information</legend>
            
            <div class="form-group">
              <label for="barriers">Specific Barriers or Challenges</label>
              <textarea id="barriers" name="barriers" placeholder="Describe any specific barriers, obstacles, or challenges encountered on this trail..."></textarea>
            </div>
            
            <div class="form-group">
              <label for="recommendations">Recommendations & Tips</label>
              <textarea id="recommendations" name="recommendations" placeholder="Share any recommendations or tips for other users..."></textarea>
            </div>
          </fieldset>
        </form>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeAccessibilityForm()">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="submitAccessibilityForm()">
          Save Survey
        </button>
      </div>
    </div>
  </div>

  <!-- Hidden buttons that your controllers expect -->
  <div style="display: none;">
    <button id="loadMyGuidesBtn"></button>
    <button id="prepareAndExportBtn"></button>
    <button id="exportGPXBtn"></button>
    <button id="exportPDFBtn"></button>
    <button id="exportSummaryBtn"></button>
  </div>

  <!-- Your Existing JavaScript Files -->
  <script type="module">
    // Try to load main.js with error handling
    try {
      await import('./src/main.js');
      console.log('‚úÖ main.js loaded successfully');
    } catch (error) {
      console.error('‚ùå Failed to load main.js:', error);
      console.log('üìÅ Trying alternative paths...');
      
      // Try alternative paths
      try {
        await import('./main.js');
        console.log('‚úÖ main.js loaded from root directory');
      } catch (error2) {
        console.error('‚ùå main.js not found in root either');
        console.log('üí° Please check your main.js file location');
        console.log('üí° Current attempts:');
        console.log('   - ./js/main.js');
        console.log('   - ./main.js');
        console.log('üí° Your main.js should be in one of these locations');
      }
    }
  </script>
  
  <!-- Enhanced UI Integration Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('‚úÖ Enhanced UI loaded - connecting to your existing tracker logic');
      console.log('üìã All missing elements resolved');
      console.log('üîó Your existing functions will work with enhanced interface');
      console.log('');
      console.log('üìÇ File Structure Check:');
      console.log('   Looking for your JavaScript files...');
      console.log('   If you see "Failed to load main.js" above:');
      console.log('   1. Check if tracker.html is in the same folder as index.html');
      console.log('   2. Verify js/main.js exists');
      console.log('   3. Make sure you\'re using a web server (not file://)');
      console.log('');
      
      // Initialize fallback map if Leaflet is loaded but map not initialized yet
      setTimeout(() => {
        const mapElement = document.getElementById('map');
        
        // Check if map already has Leaflet instance (from your code)
        if (mapElement && !mapElement._leaflet_id && typeof L !== 'undefined') {
          console.log('üó∫Ô∏è Your map.js didn\'t load - initializing basic fallback map...');
          
          try {
            // Create basic map centered on a default location
            window.fallbackMap = L.map('map').setView([51.505, -0.09], 13);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '¬© OpenStreetMap contributors',
              maxZoom: 19
            }).addTo(window.fallbackMap);
            
            // Add location control
            window.fallbackMap.locate({setView: true, maxZoom: 16});
            
            // Add marker on location found
            window.fallbackMap.on('locationfound', function(e) {
              console.log('üìç Location found:', e.latlng);
              L.marker(e.latlng).addTo(window.fallbackMap)
                .bindPopup('You are here!')
                .openPopup();
            });
            
            window.fallbackMap.on('locationerror', function(e) {
              console.warn('‚ö†Ô∏è Location error:', e.message);
            });
            
            console.log('‚úÖ Fallback map initialized');
            
          } catch (error) {
            console.error('‚ùå Failed to initialize fallback map:', error);
          }
        } else if (mapElement && mapElement._leaflet_id) {
          console.log('‚úÖ Map already initialized by your code');
        } else if (!mapElement) {
          console.error('‚ùå Map element not found');
        } else if (typeof L === 'undefined') {
          console.error('‚ùå Leaflet library not loaded from CDN');
        }
      }, 1500); // Wait 1.5 seconds for your code to initialize map
      
      // UI update utilities for your existing code to use (optional)
      window.updateEnhancedUI = {
        updateTimer: function(time) {
          const display = document.getElementById('timerDisplay');
          if (display && time) {
            display.textContent = time;
          }
        },
        
        updateDistance: function(distance) {
          const display = document.getElementById('distanceDisplay');
          if (display && distance !== undefined) {
            display.textContent = typeof distance === 'number' ? 
              `${distance.toFixed(1)} km` : distance;
          }
        },
        
        updatePoints: function(count) {
          const display = document.getElementById('pointsDisplay');
          if (display && count !== undefined) {
            display.textContent = count.toString();
          }
        },
        
        updateCompass: function(heading) {
          const needle = document.getElementById('compassNeedle');
          const reading = document.getElementById('compassReading');
          
          if (needle && heading !== undefined) {
            needle.style.transform = `rotate(${heading}deg)`;
          }
          
          if (reading && heading !== undefined) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 
                              'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(heading / 22.5) % 16;
            reading.textContent = `${Math.round(heading)}¬∞ ${directions[index]}`;
          }
        },
        
        updateTrackingButton: function(state) {
          const btn = document.getElementById('playPauseBtn');
          if (!btn) return;
          
          btn.classList.remove('tracking', 'paused');
          
          switch(state) {
            case 'idle':
              btn.innerHTML = '<span>‚ñ∂</span>';
              btn.setAttribute('aria-label', 'Start tracking');
              break;
            case 'tracking':
              btn.innerHTML = '<span>‚è∏</span>';
              btn.setAttribute('aria-label', 'Pause tracking');
              btn.classList.add('tracking');
              break;
            case 'paused':
              btn.innerHTML = '<span>‚ñ∂</span>';
              btn.setAttribute('aria-label', 'Resume tracking');
              btn.classList.add('paused');
              break;
          }
        },
        
        updateSaveButton: function(hasData) {
          const btn = document.getElementById('saveBtn');
          if (btn) {
            btn.classList.toggle('ready', hasData);
          }
        }
      };
      
      // Show ready message
      setTimeout(() => {
        const readyMsg = document.createElement('div');
        readyMsg.className = 'success-message';
        
        // Check if user's functions loaded
        const userFunctionsLoaded = typeof window.startTracking === 'function' || 
                                     (typeof window.toggleTracking === 'function' && 
                                      window.toggleTracking.toString().includes('existing'));
        
        // Check if map loaded
        const mapElement = document.getElementById('map');
        const mapLoaded = mapElement && (mapElement._leaflet_id || window.fallbackMap);
        
        if (userFunctionsLoaded && mapLoaded) {
          readyMsg.textContent = '‚úÖ Enhanced UI + Your tracking logic + Map ready!';
          console.log('‚úÖ Your existing tracking functions detected and connected');
        } else if (mapLoaded) {
          readyMsg.textContent = '‚úÖ Enhanced UI ready with working GPS tracker!';
          console.log('‚úÖ Fallback GPS tracking active (map initialized)');
          console.log('üí° Your main.js didn\'t load but tracker works with fallbacks');
        } else {
          readyMsg.textContent = '‚ö†Ô∏è Enhanced UI loaded (check console for details)';
          readyMsg.className = 'error-message';
          console.warn('‚ö†Ô∏è Map failed to initialize');
          console.log('üí° Check console messages above for file loading issues');
        }
        
        readyMsg.setAttribute('role', 'status');
        document.body.appendChild(readyMsg);
        
        setTimeout(() => {
          if (readyMsg.parentNode) {
            readyMsg.parentNode.removeChild(readyMsg);
          }
        }, 5000);
      }, 2000); // Wait 2 seconds for modules to load
    });
    
    // Fallback functions (only used if your existing functions don't exist)
    if (typeof toggleMapRotation === 'undefined') {
      window.toggleMapRotation = function() {
        const btn = document.getElementById('rotationToggle');
        if (btn) {
          btn.classList.toggle('active');
        }
        console.log('üß≠ Map rotation toggled');
      };
    }
    
    if (typeof goHome === 'undefined') {
      window.goHome = function() {
        window.location.href = 'index.html';
      };
    }
    
    if (typeof openMainMenu === 'undefined') {
      window.openMainMenu = function() {
        alert('Main Menu:\n- Export Routes\n- View History\n- Settings\n- Help');
      };
    }

    if (typeof openAccessibilityForm === 'undefined') {
      window.openAccessibilityForm = function() {
        const modal = document.getElementById('accessibilityModal');
        if (modal) {
          modal.style.display = 'block';
          const firstInput = modal.querySelector('input, select, textarea');
          if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
          }
        }
      };
    }

    if (typeof closeAccessibilityForm === 'undefined') {
      window.closeAccessibilityForm = function() {
        const modal = document.getElementById('accessibilityModal');
        if (modal) {
          modal.style.display = 'none';
        }
      };
    }

    if (typeof submitAccessibilityForm === 'undefined') {
      window.submitAccessibilityForm = function() {
        const form = document.getElementById('accessibilityForm');
        if (form) {
          const formData = new FormData(form);
          const data = {};
          
          for (let [key, value] of formData.entries()) {
            data[key] = value;
          }
          
          const radioInputs = form.querySelectorAll('input[type="radio"]:checked');
          radioInputs.forEach(input => {
            data[input.name] = input.value;
          });
          
          try {
            const surveys = JSON.parse(localStorage.getItem('accessnature_accessibility_surveys') || '[]');
            surveys.push({
              ...data,
              timestamp: new Date().toISOString(),
              id: Date.now()
            });
            localStorage.setItem('accessnature_accessibility_surveys', JSON.stringify(surveys));
            
            const successMsg = document.createElement('div');
            successMsg.className = 'success-message';
            successMsg.textContent = '‚úÖ Accessibility survey saved!';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
              if (successMsg.parentNode) {
                successMsg.parentNode.removeChild(successMsg);
              }
            }, 3000);
            
            closeAccessibilityForm();
            form.reset();
            
          } catch (error) {
            console.error('Failed to save accessibility data:', error);
            alert('Failed to save survey. Please try again.');
          }
        }
      };
    }

    if (typeof toggleTracking === 'undefined') {
      window.toggleTracking = function() {
        console.log('üìç Using fallback GPS tracking');
        
        if (!window.trackingState) {
          window.trackingState = 'idle';
          window.trackingPoints = [];
          window.trackingStartTime = null;
        }
        
        const btn = document.getElementById('playPauseBtn');
        
        if (window.trackingState === 'idle') {
          // Start tracking
          window.trackingState = 'tracking';
          window.trackingStartTime = Date.now();
          
          if (btn) {
            btn.innerHTML = '<span>‚è∏</span>';
            btn.classList.add('tracking');
          }
          
          // Start GPS tracking
          if (navigator.geolocation) {
            window.trackingWatchId = navigator.geolocation.watchPosition(
              (position) => {
                const point = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude,
                  accuracy: position.coords.accuracy,
                  timestamp: new Date()
                };
                
                window.trackingPoints.push(point);
                
                // Update UI
                if (window.updateEnhancedUI) {
                  window.updateEnhancedUI.updatePoints(window.trackingPoints.length);
                  window.updateEnhancedUI.updateSaveButton(window.trackingPoints.length > 0);
                }
                
                // Add marker to map
                if (window.fallbackMap) {
                  L.marker([point.lat, point.lng]).addTo(window.fallbackMap);
                  window.fallbackMap.setView([point.lat, point.lng]);
                }
                
                console.log(`üìç GPS point recorded: ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)} (${window.trackingPoints.length} points)`);
              },
              (error) => {
                console.error('GPS Error:', error.message);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.textContent = '‚ùå GPS Error: ' + error.message;
                document.body.appendChild(errorMsg);
                setTimeout(() => errorMsg.remove(), 5000);
              },
              {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
              }
            );
            
            const successMsg = document.createElement('div');
            successMsg.className = 'success-message';
            successMsg.textContent = '‚úÖ GPS tracking started!';
            document.body.appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 3000);
          }
          
        } else if (window.trackingState === 'tracking') {
          // Pause tracking
          window.trackingState = 'paused';
          
          if (btn) {
            btn.innerHTML = '<span>‚ñ∂</span>';
            btn.classList.remove('tracking');
            btn.classList.add('paused');
          }
          
          if (window.trackingWatchId) {
            navigator.geolocation.clearWatch(window.trackingWatchId);
          }
          
          console.log('‚è∏Ô∏è GPS tracking paused');
          
        } else if (window.trackingState === 'paused') {
          // Resume tracking
          window.trackingState = 'tracking';
          
          if (btn) {
            btn.innerHTML = '<span>‚è∏</span>';
            btn.classList.remove('paused');
            btn.classList.add('tracking');
          }
          
          console.log('‚ñ∂Ô∏è GPS tracking resumed');
        }
      };
    }

    if (typeof saveRoute === 'undefined') {
      window.saveRoute = function() {
        console.log('üíæ Using fallback save route');
        
        if (!window.trackingPoints || window.trackingPoints.length === 0) {
          const errorMsg = document.createElement('div');
          errorMsg.className = 'error-message';
          errorMsg.textContent = '‚ö†Ô∏è No GPS points to save. Start tracking first!';
          document.body.appendChild(errorMsg);
          setTimeout(() => errorMsg.remove(), 4000);
          return;
        }
        
        // Stop tracking if active
        if (window.trackingState === 'tracking' && window.trackingWatchId) {
          navigator.geolocation.clearWatch(window.trackingWatchId);
          window.trackingState = 'idle';
          
          const btn = document.getElementById('playPauseBtn');
          if (btn) {
            btn.innerHTML = '<span>‚ñ∂</span>';
            btn.classList.remove('tracking', 'paused');
          }
        }
        
        // Create route object
        const route = {
          id: 'route_' + Date.now(),
          name: 'Trail Route ' + new Date().toLocaleDateString(),
          startTime: window.trackingStartTime ? new Date(window.trackingStartTime) : new Date(),
          endTime: new Date(),
          points: window.trackingPoints,
          pointCount: window.trackingPoints.length,
          metadata: {
            created: new Date().toISOString(),
            device: 'Access Nature Enhanced Tracker'
          }
        };
        
        // Save to localStorage
        try {
          const routes = JSON.parse(localStorage.getItem('accessnature_routes') || '[]');
          routes.push(route);
          localStorage.setItem('accessnature_routes', JSON.stringify(routes));
          
          console.log(`üíæ Route saved: ${route.pointCount} GPS points`);
          
          const successMsg = document.createElement('div');
          successMsg.className = 'success-message';
          successMsg.innerHTML = `‚úÖ Route saved!<br>${route.pointCount} GPS points recorded`;
          document.body.appendChild(successMsg);
          setTimeout(() => successMsg.remove(), 4000);
          
          // Reset tracking
          window.trackingPoints = [];
          window.trackingStartTime = null;
          window.trackingState = 'idle';
          
          if (window.updateEnhancedUI) {
            window.updateEnhancedUI.updatePoints(0);
            window.updateEnhancedUI.updateSaveButton(false);
          }
          
        } catch (error) {
          console.error('Failed to save route:', error);
          const errorMsg = document.createElement('div');
          errorMsg.className = 'error-message';
          errorMsg.textContent = '‚ùå Failed to save route';
          document.body.appendChild(errorMsg);
          setTimeout(() => errorMsg.remove(), 4000);
        }
      };
    }

    if (typeof addNote === 'undefined') {
      window.addNote = function() {
        const note = prompt('Add a note about this location:');
        if (note && note.trim()) {
          try {
            const notes = JSON.parse(localStorage.getItem('accessnature_notes') || '[]');
            notes.push({
              text: note.trim(),
              timestamp: new Date().toISOString(),
              id: Date.now()
            });
            localStorage.setItem('accessnature_notes', JSON.stringify(notes));
            
            const successMsg = document.createElement('div');
            successMsg.className = 'success-message';
            successMsg.textContent = '‚úÖ Note saved!';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
              if (successMsg.parentNode) {
                successMsg.parentNode.removeChild(successMsg);
              }
            }, 3000);
            
          } catch (error) {
            console.error('Failed to save note:', error);
          }
        }
      };
    }

    if (typeof capturePhoto === 'undefined') {
      window.capturePhoto = function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.capture = 'environment';
        
        input.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const successMsg = document.createElement('div');
            successMsg.className = 'success-message';
            successMsg.textContent = 'üì∑ Photo captured!';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
              if (successMsg.parentNode) {
                successMsg.parentNode.removeChild(successMsg);
              }
            }, 3000);
          }
        });
        
        input.click();
      };
    }
  </script>
</body>
</html>